<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSCE Dashboard (Display)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        :root {
            --bg-color: #121212; --surface: #1e1e1e; --text: #ffffff;
            --prep-color: #d97706; --station-color: #059669; --move-color: #2563eb;
            --ready-color: #374151; --standby-color: #0f172a; --stop-color: #b91c1c;
            --intermission-color: #111; --extra-prep: #7c2d12; --extra-station: #064e3b;
            --sidebar-bg: #111; --sidebar-border: #333;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-color); color: var(--text); margin: 0; overflow: hidden; height: 100vh; display:flex; flex-direction:column; }

        /* SETUP SCREEN */
        #setup-view { padding: 40px; max-width: 900px; margin: 0 auto; height: 100vh; overflow-y: auto; position: relative; }
        .card { background: var(--surface); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        textarea { width: 100%; height: 120px; background: #2d2d2d; border: 1px solid #444; color: #fff; font-family: monospace; }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-top: 20px; }
        input, select { background: #333; color: white; border: 1px solid #555; padding: 10px; width: 100%; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #2563eb; color: white; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-top: 10px; border-radius: 6px;}
        
        /* REMOTE CODE BOX (Bottom Left) */
        #remote-box {
            position: fixed; bottom: 20px; left: 20px;
            background: #111; border: 1px solid #333; padding: 15px;
            border-radius: 8px; display: flex; flex-direction: column; gap: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 1000;
        }
        #remote-label { font-size: 0.8rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        #remote-code { font-size: 2rem; font-weight: bold; color: #3b82f6; font-family: monospace; letter-spacing: 2px; }
        #conn-status { font-size: 0.8rem; color: #555; display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .status-dot.on { background: #10b981; box-shadow: 0 0 5px #10b981; }

        /* DASHBOARD */
        #run-view { display: none; height: 100vh; width: 100vw; grid-template-columns: 20% 60% 20%; }
        .sidebar { background: var(--sidebar-bg); border-right: 1px solid var(--sidebar-border); display: flex; flex-direction: column; overflow: hidden; }
        .sidebar-right { border-right: none; border-left: 1px solid var(--sidebar-border); }
        .sidebar h3 { margin: 0; padding: 20px; font-size: 1.2rem; color: #888; border-bottom: 2px solid #444; text-align: center; background: var(--sidebar-bg); text-transform: uppercase; }
        .student-list { list-style: none; padding: 10px; margin: 0; flex-grow: 1; overflow-y: auto; }
        .student-item { padding: 10px 12px; margin-bottom: 6px; background: #252525; border-left: 6px solid #555; display: flex; justify-content: space-between; }
        .group-tag { font-size: 0.75rem; font-weight: bold; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; background: #444; color: #ddd; }
        
        .grp-red { border-left-color: #ef4444; } .grp-red .group-tag { background: #ef4444; color: white; }
        .grp-blue { border-left-color: #3b82f6; } .grp-blue .group-tag { background: #3b82f6; color: white; }
        .grp-green { border-left-color: #10b981; } .grp-green .group-tag { background: #10b981; color: white; }
        .grp-yellow { border-left-color: #eab308; } .grp-yellow .group-tag { background: #eab308; color: black; }

        .main-stage { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; width: 100%; transition: background 0.5s; position: relative; }
        #status-text { font-size: 5vw; font-weight: 800; margin: 0; }
        #timer { font-size: 15vw; font-weight: 700; margin: 20px 0; font-variant-numeric: tabular-nums; line-height: 1; }
        #info-bar { font-size: 1.5vw; background: rgba(0,0,0,0.4); padding: 10px 40px; border-radius: 50px; }
        
        .mode-standby { background: var(--standby-color); } .mode-ready { background: var(--ready-color); }
        .mode-prep { background: var(--prep-color); } .mode-station { background: var(--station-color); }
        .mode-move { background: var(--move-color); } .mode-intermission { background: var(--intermission-color); }
        .mode-et-prep { background: var(--extra-prep); } .mode-et-station { background: var(--extra-station); }
        .mode-done { background: var(--stop-color); }

        #action-btn { display: none; margin-top: 30px; font-size: 2rem; padding: 20px 60px; background: #2563eb; color: white; border: none; border-radius: 50px; cursor: pointer; animation: pulse 2s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
    </style>
</head>
<body>

    <div id="setup-view">
        <div class="card">
            <h3>Student Data</h3>
            <textarea id="paste-area" placeholder="ET     Noah    Bansal     Red&#10;        Nargis  Abarok     Green"></textarea>
            <button onclick="analyze()" style="background:#4b5563;">Analyze Data</button>
            <div id="analysis-summary" style="margin-top:10px; color:#aaa;"></div>
        </div>

        <div class="card">
            <div class="config-grid">
                <div><label>Prep Time</label><div style="display:flex; gap:5px;"><input type="number" id="val-prep" value="1"><select id="unit-prep"><option value="min">Min</option><option value="sec">Sec</option></select></div></div>
                <div><label>Station Time</label><div style="display:flex; gap:5px;"><input type="number" id="val-station" value="7"><select id="unit-station"><option value="min">Min</option><option value="sec">Sec</option></select></div></div>
                <div><label>Move Time</label><div style="display:flex; gap:5px;"><input type="number" id="val-move" value="1"><select id="unit-move"><option value="min">Min</option><option value="sec">Sec</option></select></div></div>
                <div><label>Lead-In (Sec)</label><input type="number" id="val-leadin" value="10"></div>
                <div><label>Capacity</label><input type="number" id="capacity" value="12"></div>
                <div><label>Stations/Circuit</label><input type="number" id="stations-count" value="4"></div>
            </div>
        </div>
        <button onclick="startExam()">LOAD EXAM</button>
    </div>

    <div id="remote-box">
        <div id="remote-label">Remote Code</div>
        <div id="remote-code">....</div>
        <div id="conn-status"><div class="status-dot" id="dot"></div> <span id="status-txt">Connecting...</span></div>
    </div>

    <div id="run-view">
        <div class="sidebar"><h3 id="lbl-left">Current</h3><ul id="list-current" class="student-list"></ul></div>
        <div class="main-stage" id="main-stage-bg">
            <div id="status-text">WELCOME</div>
            <div id="timer">--:--</div>
            <div id="info-bar">PLEASE WAIT</div>
            <button id="action-btn" onclick="nextSection()">BEGIN</button>
        </div>
        <div class="sidebar sidebar-right"><h3>Up Next</h3><ul id="list-next" class="student-list"></ul></div>
    </div>

    <script>
        // --- SECURE MQTT SETUP ---
        const BROKER = "broker.emqx.io";
        const PORT = 8084; // SSL Port
        const EXAM_ID = Math.floor(1000 + Math.random() * 9000).toString();
        let client = null;

        function connectMQTT() {
            document.getElementById('remote-code').innerText = EXAM_ID;
            const clientId = "host_" + Math.random().toString(16).substr(2, 8);
            client = new Paho.MQTT.Client(BROKER, PORT, "/mqtt", clientId);

            client.onConnectionLost = (obj) => {
                document.getElementById('status-txt').innerText = "Reconnecting...";
                document.getElementById('dot').classList.remove('on');
                setTimeout(connectMQTT, 2000);
            };

            client.onMessageArrived = (msg) => {
                const cmd = JSON.parse(msg.payloadString).action;
                if(cmd === 'NEXT') {
                    if(document.getElementById('action-btn').style.display !== 'none') nextSection();
                }
                if(cmd === 'PAUSE') togglePause();
            };

            client.connect({
                useSSL: true,
                onSuccess: () => {
                    document.getElementById('status-txt').innerText = "Online";
                    document.getElementById('dot').classList.add('on');
                    client.subscribe(`osce/${EXAM_ID}/cmd`);
                },
                onFailure: (e) => { console.log(e); }
            });
        }
        
        connectMQTT();

        // --- EXAM LOGIC ---
        let etStudents=[], stdStudents=[], schedule=[];
        let currentStepIndex=0, timerInterval=null, timeLeft=0, isPaused=false, capacity=12, audioCtx=null;

        function getSeconds(v, u) { 
            const val = parseFloat(document.getElementById(v).value)||0; 
            return document.getElementById(u).value==='min' ? val*60 : val; 
        }

        function analyze() {
            const raw = document.getElementById('paste-area').value.split('\n');
            capacity = parseInt(document.getElementById('capacity').value)||12;
            etStudents=[]; stdStudents=[];
            
            raw.forEach(l => {
                const p = l.split('\t').map(t=>t.trim());
                if(p.join('').length<2) return;
                
                let grp="Unknown", gIdx=-1;
                ['red','blue','green','yellow'].forEach(c => {
                    for(let i=p.length-1; i>=0; i--) if(p[i].toLowerCase().includes(c)) { grp=p[i]; gIdx=i; }
                });

                let isET=false, nStart=0;
                const c0 = p[0].toLowerCase();
                if(['et','yes','25','extra','y'].includes(c0) || c0.startsWith('25%')) { isET=true; nStart=1; }
                else if(c0==="") { isET=false; nStart=1; }

                const name = p.slice(nStart, gIdx>-1?gIdx:p.length).join(' ');
                (isET ? etStudents : stdStudents).push({name, group:grp});
            });

            const etF = Math.ceil(etStudents.length/capacity);
            const stdF = Math.ceil(stdStudents.length/capacity);
            document.getElementById('analysis-summary').innerText = `Found: ${etStudents.length} ET (${etF} flights), ${stdStudents.length} STD (${stdF} flights)`;
            return { etF, stdF };
        }

        function startExam() {
            const cts = analyze();
            const prep = getSeconds('val-prep','unit-prep');
            const stn = getSeconds('val-station','unit-station');
            const move = getSeconds('val-move','unit-move');
            const lead = parseFloat(document.getElementById('val-leadin').value)||10;
            const stops = parseInt(document.getElementById('stations-count').value)||4;

            schedule = [];
            schedule.push({ type:'STANDBY', label:'WELCOME', sub:'WAITING...', color:'mode-standby', nextT: cts.etF>0?'ET':'STD', nextI:0 });
            
            if(lead>0) schedule.push({ type:'LEAD', duration:lead, label:'GET READY', sub:'STARTING SHORTLY', color:'mode-ready', nextT: cts.etF>0?'ET':'STD', nextI:0 });

            // Build Schedule
            const addFlight = (type, fIdx, p, s, listName) => {
                for(let i=1; i<=stops; i++) {
                    schedule.push({ type, fIdx, phase:'PREP', duration:p, label:'PREPARATION', sub:`${listName} FLIGHT ${fIdx+1} - ST ${i}`, color: type==='ET'?'mode-et-prep':'mode-prep' });
                    schedule.push({ type, fIdx, phase:'STATION', duration:s, label:'STATION', sub:`${listName} FLIGHT ${fIdx+1} - ST ${i}`, color: type==='ET'?'mode-et-station':'mode-station' });
                    schedule.push({ type, fIdx, phase:'MOVE', duration:move, label:'MOVE', sub:'MOVE TO NEXT', color:'mode-move' });
                }
            };

            for(let f=0; f<cts.etF; f++) {
                addFlight('ET', f, prep*1.25, stn*1.25, "EXTRA TIME");
                if(f+1 < cts.etF || cts.stdF>0) schedule.push({ type:'INT', label:'INTERMISSION', sub:'CHANGE GROUP', color:'mode-intermission', nextT:(f+1<cts.etF?'ET':'STD'), nextI:(f+1<cts.etF?f+1:0) });
            }

            for(let f=0; f<cts.stdF; f++) {
                addFlight('STD', f, prep, stn, "STANDARD");
                if(f+1 < cts.stdF) schedule.push({ type:'INT', label:'INTERMISSION', sub:'CHANGE GROUP', color:'mode-intermission', nextT:'STD', nextI:f+1 });
            }

            if(schedule.length===1) return alert("No students found.");
            
            try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){}

            currentStepIndex = 0;
            document.getElementById('setup-view').style.display='none';
            document.getElementById('run-view').style.display='grid';
            runStep();
        }

        function runStep() {
            if(currentStepIndex >= schedule.length) { finish(); return; }
            const step = schedule[currentStepIndex];

            document.getElementById('status-text').innerText = step.label;
            document.getElementById('info-bar').innerText = step.sub;
            document.getElementById('main-stage-bg').className = 'main-stage ' + step.color;
            updateSidebars(step);

            if(['STANDBY','INT','LEAD'].includes(step.type) && step.phase !== 'READY') {
                clearInterval(timerInterval);
                document.getElementById('timer').innerText = "--:--";
                const btn = document.getElementById('action-btn');
                btn.style.display = 'inline-block';
                btn.innerText = step.type==='STANDBY' ? "BEGIN EXAM" : "START FLIGHT";
                if(step.type==='INT') playBeep(600, 0.4);
                return;
            }

            document.getElementById('action-btn').style.display = 'none';
            timeLeft = Math.floor(step.duration);
            updateTimerDisplay();

            if(step.phase==='PREP') playBeep(440, 0.6);
            if(step.phase==='STATION') { playBeep(800,0.15); setTimeout(()=>playBeep(800,0.4), 200); }
            if(step.phase==='MOVE') playBeep(600, 0.3);

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if(!isPaused) {
                    timeLeft--;
                    updateTimerDisplay();
                    if(timeLeft<0) { currentStepIndex++; runStep(); }
                }
            }, 1000);
        }

        function updateSidebars(step) {
            const slice = (arr, i) => arr.slice(i*capacity, (i*capacity)+capacity);
            let left=[], right=[];

            if(['STANDBY','LEAD','INT'].includes(step.type)) {
                document.getElementById('lbl-left').innerText = "Get Ready";
                if(step.nextT === 'ET') left = slice(etStudents, step.nextI);
                else left = slice(stdStudents, step.nextI);
            } else {
                document.getElementById('lbl-left').innerText = "Current";
                if(step.type === 'ET') left = slice(etStudents, step.fIdx);
                else left = slice(stdStudents, step.fIdx);
            }
            renderList('list-current', left);
            renderList('list-next', []);
        }

        function renderList(id, list) {
            const ul = document.getElementById(id); ul.innerHTML = '';
            if(!list || list.length===0) { ul.innerHTML='<li style="text-align:center; color:#555">-</li>'; return; }
            list.sort((a,b)=>(a.group||"").localeCompare(b.group||""));
            list.forEach(s => {
                const li = document.createElement('li');
                let c = "";
                const g = (s.group||"").toLowerCase();
                if(g.includes('red')) c='grp-red'; if(g.includes('blue')) c='grp-blue';
                if(g.includes('green')) c='grp-green'; if(g.includes('yellow')) c='grp-yellow';
                li.className = `student-item ${c}`;
                li.innerHTML = `<span>${s.name}</span> <span class="group-tag" style="background:#444;">${s.group}</span>`;
                ul.appendChild(li);
            });
        }

        function nextSection() { currentStepIndex++; runStep(); }
        function togglePause() { isPaused = !isPaused; }
        function updateTimerDisplay() {
            const m = Math.floor(timeLeft/60).toString().padStart(2,'0');
            const s = (timeLeft%60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }
        function finish() {
            clearInterval(timerInterval);
            document.getElementById('status-text').innerText = "COMPLETE";
            document.getElementById('timer').innerText = "00:00";
            playBeep(600,0.2);
        }
        function playBeep(f,d) {
            if(!audioCtx) return;
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.frequency.value=f; o.start(); 
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+d); 
            o.stop(audioCtx.currentTime+d);
        }
    </script>
</body>
</html>
